<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>misas - Case Study - Model Robustness</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="misas - Case Study - Model Robustness">
<meta property="og:description" content="We often find ourselves in a situation where we have trained a model for a certain task. The network performs well on the training and validation data. It also performs good on the hold out test set.">
<meta property="og:site-name" content="misas">
<meta name="twitter:title" content="misas - Case Study - Model Robustness">
<meta name="twitter:description" content="We often find ourselves in a situation where we have trained a model for a certain task. The network performs well on the training and validation data. It also performs good on the hold out test set.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">misas</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Case Study - Model Robustness</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Model Interpretation through Sensitivity Analysis for Segmentation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./local_interpret.html" class="sidebar-item-text sidebar-link">Local Interpretability</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ukbb_on_kaggle.html" class="sidebar-item-text sidebar-link">Case Study - Model Suitability</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transversals.html" class="sidebar-item-text sidebar-link active">Case Study - Model Robustness</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mr_artifacts.html" class="sidebar-item-text sidebar-link">Simulated MR artifacts (torchio)</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./camvid.html" class="sidebar-item-text sidebar-link">CamVid Demo</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pneumothorax.html" class="sidebar-item-text sidebar-link">Pneumothorax demo</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./myops.html" class="sidebar-item-text sidebar-link">Case Study: MyoPS - myocardial pathology segmentation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./batch_mode.html" class="sidebar-item-text sidebar-link">Batch Mode</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fastai_model.html" class="sidebar-item-text sidebar-link">Fastai Model (misas)</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tensorflow_model.html" class="sidebar-item-text sidebar-link">Tensorflow Model (misas)</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#aim-how-robust-is-my-network-to-shifts-in-data" id="toc-aim-how-robust-is-my-network-to-shifts-in-data" class="nav-link active" data-scroll-target="#aim-how-robust-is-my-network-to-shifts-in-data">Aim: How robust is my network to shifts in data</a></li>
  <li><a href="#prepare-model-for-misas" id="toc-prepare-model-for-misas" class="nav-link" data-scroll-target="#prepare-model-for-misas">Prepare Model for <code>misas</code></a></li>
  <li><a href="#prepare-dataset-for-misas" id="toc-prepare-dataset-for-misas" class="nav-link" data-scroll-target="#prepare-dataset-for-misas">Prepare Dataset for <code>misas</code></a></li>
  <li><a href="#how-does-the-trained-model-perform-on-this-training-example" id="toc-how-does-the-trained-model-perform-on-this-training-example" class="nav-link" data-scroll-target="#how-does-the-trained-model-perform-on-this-training-example">How does the trained model perform on this (training) example?</a></li>
  <li><a href="#robustness-to-basic-transformations" id="toc-robustness-to-basic-transformations" class="nav-link" data-scroll-target="#robustness-to-basic-transformations">Robustness to basic transformations</a>
  <ul class="collapse">
  <li><a href="#sensitivity-to-orientation" id="toc-sensitivity-to-orientation" class="nav-link" data-scroll-target="#sensitivity-to-orientation">Sensitivity to orientation</a></li>
  <li><a href="#sensitivity-to-rotation" id="toc-sensitivity-to-rotation" class="nav-link" data-scroll-target="#sensitivity-to-rotation">Sensitivity to rotation</a></li>
  <li><a href="#sensitivity-to-cropping" id="toc-sensitivity-to-cropping" class="nav-link" data-scroll-target="#sensitivity-to-cropping">Sensitivity to cropping</a></li>
  <li><a href="#sensitivity-to-brightness" id="toc-sensitivity-to-brightness" class="nav-link" data-scroll-target="#sensitivity-to-brightness">Sensitivity to brightness</a></li>
  <li><a href="#sensitivity-to-contrast" id="toc-sensitivity-to-contrast" class="nav-link" data-scroll-target="#sensitivity-to-contrast">Sensitivity to contrast</a></li>
  <li><a href="#sensitivity-to-zoom" id="toc-sensitivity-to-zoom" class="nav-link" data-scroll-target="#sensitivity-to-zoom">Sensitivity to zoom</a></li>
  </ul></li>
  <li><a href="#robustness-to-mr-artifacts" id="toc-robustness-to-mr-artifacts" class="nav-link" data-scroll-target="#robustness-to-mr-artifacts">Robustness to MR artifacts</a>
  <ul class="collapse">
  <li><a href="#spike-artifact" id="toc-spike-artifact" class="nav-link" data-scroll-target="#spike-artifact">Spike artifact</a></li>
  <li><a href="#b_0-field-inhomogeneity" id="toc-b_0-field-inhomogeneity" class="nav-link" data-scroll-target="#b_0-field-inhomogeneity"><span class="math inline">\(B_0\)</span>-Field inhomogeneity</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chfc-cmi/misas/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Case Study - Model Robustness</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="aim-how-robust-is-my-network-to-shifts-in-data" class="level2">
<h2 class="anchored" data-anchor-id="aim-how-robust-is-my-network-to-shifts-in-data">Aim: How robust is my network to shifts in data</h2>
<p>We often find ourselves in a situation where we have trained a model for a certain task. The network performs well on the training and validation data. It also performs good on the hold out test set. Still you wonder what happens when you feed it data that is systematically different from all three sets? Does it make sense to re-train with more extensive data augmentation?</p>
<p>In this case study we demonstrate how <code>misas</code> helps answer these questions with a concrete example: - <strong>Model</strong>: Custom U-Net - <strong>Data</strong>: Small set of transversal CMR images</p>
</section>
<section id="prepare-model-for-misas" class="level2">
<h2 class="anchored" data-anchor-id="prepare-model-for-misas">Prepare Model for <code>misas</code></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> misas.core <span class="im">import</span> default_cmap</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> misas.fastai_model <span class="im">import</span> Fastai2_model</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>trainedModel <span class="op">=</span> Fastai2_model(<span class="st">'chfc-cmi/transversal-cmr-seg'</span>, <span class="st">'b0_transversal_5_5'</span>, force_reload<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using cache found in /home/markus/.cache/torch/hub/chfc-cmi_transversal-cmr-seg_master</code></pre>
</div>
</div>
</section>
<section id="prepare-dataset-for-misas" class="level2">
<h2 class="anchored" data-anchor-id="prepare-dataset-for-misas">Prepare Dataset for <code>misas</code></h2>
<p>Data is available as png images and masks which is just fine for <code>misas</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"example/b0/images/train_example.png"</span>).convert(<span class="st">"RGB"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>plt.imshow(img)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>img.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(128, 128)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-4-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="how-does-the-trained-model-perform-on-this-training-example" class="level2">
<h2 class="anchored" data-anchor-id="how-does-the-trained-model-perform-on-this-training-example">How does the trained model perform on this (training) example?</h2>
<p>Time to apply the model to the example image and see how it works (we need to call <code>prepareSize</code> manually here):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> trainedModel.prepareSize(img)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>fig,ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>plt.imshow(img)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> plt.imshow(trainedModel.predict(img), cmap<span class="op">=</span>default_cmap, alpha<span class="op">=</span><span class="fl">.5</span>, interpolation<span class="op">=</span><span class="st">"nearest"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>So how does it perform on validation data?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> <span class="bu">sorted</span>(glob(<span class="st">"example/b0/images/val*.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">10</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axs.flatten()):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    fname <span class="op">=</span> files[i]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> trainedModel.prepareSize(Image.<span class="bu">open</span>(fname).convert(<span class="st">"RGB"</span>))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    ax.imshow(tmp)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    ax.imshow(trainedModel.predict(tmp), cmap<span class="op">=</span>default_cmap, alpha<span class="op">=</span><span class="fl">.5</span>, interpolation<span class="op">=</span><span class="st">"nearest"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>This is not great. But given the limited training data it looks decent. So let’s have a closer look on how robust this model is. In particular to differences we might encounter when applying this network to new data.</p>
</section>
<section id="robustness-to-basic-transformations" class="level2">
<h2 class="anchored" data-anchor-id="robustness-to-basic-transformations">Robustness to basic transformations</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> misas.core <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> <span class="kw">lambda</span>: Image.<span class="bu">open</span>(files[<span class="dv">0</span>]).convert(<span class="st">"RGB"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>trueMask <span class="op">=</span> <span class="kw">lambda</span>: Image.<span class="bu">open</span>(files[<span class="dv">0</span>].replace(<span class="st">"image"</span>,<span class="st">"mask"</span>)).convert(<span class="st">"I"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sensitivity-to-orientation" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-to-orientation">Sensitivity to orientation</h3>
<p>Changes in orientation are very common. Not because it is common to acquire images in different orientation but because the way data is stored in different file formats like nifti and dicom differs. So it is interesting to see how the model works in all possible orientations (including flips).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_dihedral_series(img(),trainedModel), nrow<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> eval_dihedral_series(img(),trueMask(),trainedModel,components<span class="op">=</span>[<span class="st">"bg"</span>,<span class="st">"LV"</span>,<span class="st">"MY"</span>])</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>k</th>
      <th>bg</th>
      <th>LV</th>
      <th>MY</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0.995824</td>
      <td>0.782609</td>
      <td>0.765604</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0.963374</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0.977227</td>
      <td>0.000000</td>
      <td>0.029690</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>0.985537</td>
      <td>0.657269</td>
      <td>0.206577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>0.979158</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5</td>
      <td>0.987976</td>
      <td>0.625101</td>
      <td>0.439119</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6</td>
      <td>0.979158</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7</td>
      <td>0.992134</td>
      <td>0.728850</td>
      <td>0.640967</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Not surprisingly, the model is very sensitive to changes in orientation. So when using this model it is very important to feed the images in the proper orientation.</p>
<p>Another really interesting thing is that the heart is never properly segmented when images are flipped horizontally, so the heart is on the left instead of the right side. This gives a strong indication that the location within the image is one of the features the network has learned. Depending on your use case this might indeed be a sensible feature to use for segmentation of the heart as in a huge majority of cases the left ventricle of the heart is on the left side of the chest (so showing up on the right side in transversal slices).</p>
</section>
<section id="sensitivity-to-rotation" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-to-rotation">Sensitivity to rotation</h3>
<p>There should not be a huge variation in rotation (by small angles) when working with transversal slices. Still it is a good idea to get an impression of how quickly segmentation performance decreases with deviations in rotation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_rotation_series(img(),trainedModel, step<span class="op">=</span><span class="dv">30</span>, end<span class="op">=</span><span class="dv">360</span>), nrow<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> eval_rotation_series(img(),trueMask(),trainedModel,start<span class="op">=-</span><span class="dv">180</span>,end<span class="op">=</span><span class="dv">180</span>,components<span class="op">=</span>[<span class="st">"bg"</span>,<span class="st">"LV"</span>,<span class="st">"MY"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(alt</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a> .Chart(results.melt(id_vars<span class="op">=</span>[<span class="st">'deg'</span>],value_vars<span class="op">=</span>[<span class="st">'LV'</span>,<span class="st">'MY'</span>]))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a> .mark_line()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a> .encode(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>     x<span class="op">=</span>alt.X(<span class="st">"deg"</span>,axis<span class="op">=</span>alt.Axis(title<span class="op">=</span><span class="va">None</span>)),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>     y<span class="op">=</span>alt.Y(<span class="st">"value"</span>,axis<span class="op">=</span>alt.Axis(title<span class="op">=</span><span class="va">None</span>)),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>     color<span class="op">=</span>alt.Color(<span class="st">"variable"</span>,legend<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>     tooltip<span class="op">=</span><span class="st">"value"</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> .properties(width<span class="op">=</span><span class="dv">700</span>,height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a> .interactive()</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-9e02e674f3174a79815500ad2b451fbd"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-9e02e674f3174a79815500ad2b451fbd") {
      outputDiv = document.getElementById("altair-viz-9e02e674f3174a79815500ad2b451fbd");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-9096a4aa55a973f70e7b842415f8eee1"}, "mark": "line", "encoding": {"color": {"field": "variable", "legend": null, "type": "nominal"}, "tooltip": {"field": "value", "type": "quantitative"}, "x": {"axis": {"title": null}, "field": "deg", "type": "quantitative"}, "y": {"axis": {"title": null}, "field": "value", "type": "quantitative"}}, "height": 300, "selection": {"selector001": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}, "width": 700, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json", "datasets": {"data-9096a4aa55a973f70e7b842415f8eee1": [{"deg": -180, "variable": "LV", "value": 0.0}, {"deg": -175, "variable": "LV", "value": 0.0}, {"deg": -170, "variable": "LV", "value": 0.0}, {"deg": -165, "variable": "LV", "value": 0.0}, {"deg": -160, "variable": "LV", "value": 0.0}, {"deg": -155, "variable": "LV", "value": 0.0}, {"deg": -150, "variable": "LV", "value": 0.0}, {"deg": -145, "variable": "LV", "value": 0.0}, {"deg": -140, "variable": "LV", "value": 0.0}, {"deg": -135, "variable": "LV", "value": 0.0}, {"deg": -130, "variable": "LV", "value": 0.0}, {"deg": -125, "variable": "LV", "value": 0.0}, {"deg": -120, "variable": "LV", "value": 0.0}, {"deg": -115, "variable": "LV", "value": 0.0}, {"deg": -110, "variable": "LV", "value": 0.0}, {"deg": -105, "variable": "LV", "value": 0.0}, {"deg": -100, "variable": "LV", "value": 0.0}, {"deg": -95, "variable": "LV", "value": 0.0}, {"deg": -90, "variable": "LV", "value": 0.0}, {"deg": -85, "variable": "LV", "value": 0.0}, {"deg": -80, "variable": "LV", "value": 0.0}, {"deg": -75, "variable": "LV", "value": 0.0}, {"deg": -70, "variable": "LV", "value": 0.16786570743405277}, {"deg": -65, "variable": "LV", "value": 0.4563279857397504}, {"deg": -60, "variable": "LV", "value": 0.18610129564193167}, {"deg": -55, "variable": "LV", "value": 0.6550569323509712}, {"deg": -50, "variable": "LV", "value": 0.736904761904762}, {"deg": -45, "variable": "LV", "value": 0.7536916715888955}, {"deg": -40, "variable": "LV", "value": 0.7673716012084593}, {"deg": -35, "variable": "LV", "value": 0.7620730270906949}, {"deg": -30, "variable": "LV", "value": 0.7584597432905484}, {"deg": -25, "variable": "LV", "value": 0.7561837455830389}, {"deg": -20, "variable": "LV", "value": 0.7606478704259149}, {"deg": -15, "variable": "LV", "value": 0.7734282325029656}, {"deg": -10, "variable": "LV", "value": 0.7855833842394624}, {"deg": -5, "variable": "LV", "value": 0.7932542161149282}, {"deg": 0, "variable": "LV", "value": 0.782608695652174}, {"deg": 5, "variable": "LV", "value": 0.7864197530864198}, {"deg": 10, "variable": "LV", "value": 0.8197923029932804}, {"deg": 15, "variable": "LV", "value": 0.8044971892567145}, {"deg": 20, "variable": "LV", "value": 0.8094059405940595}, {"deg": 25, "variable": "LV", "value": 0.8099688473520249}, {"deg": 30, "variable": "LV", "value": 0.8296296296296296}, {"deg": 35, "variable": "LV", "value": 0.8233151183970856}, {"deg": 40, "variable": "LV", "value": 0.8086904043452021}, {"deg": 45, "variable": "LV", "value": 0.7820359281437126}, {"deg": 50, "variable": "LV", "value": 0.782393056416615}, {"deg": 55, "variable": "LV", "value": 0.7848729076255425}, {"deg": 60, "variable": "LV", "value": 0.7651951375559821}, {"deg": 65, "variable": "LV", "value": 0.7495268138801262}, {"deg": 70, "variable": "LV", "value": 0.7646276595744681}, {"deg": 75, "variable": "LV", "value": 0.45330915684496825}, {"deg": 80, "variable": "LV", "value": 0.5756097560975609}, {"deg": 85, "variable": "LV", "value": 0.0}, {"deg": 90, "variable": "LV", "value": 0.0}, {"deg": 95, "variable": "LV", "value": 0.0}, {"deg": 100, "variable": "LV", "value": 0.0}, {"deg": 105, "variable": "LV", "value": 0.0}, {"deg": 110, "variable": "LV", "value": 0.0}, {"deg": 115, "variable": "LV", "value": 0.0}, {"deg": 120, "variable": "LV", "value": 0.0}, {"deg": 125, "variable": "LV", "value": 0.0}, {"deg": 130, "variable": "LV", "value": 0.0}, {"deg": 135, "variable": "LV", "value": 0.0}, {"deg": 140, "variable": "LV", "value": 0.0}, {"deg": 145, "variable": "LV", "value": 0.0}, {"deg": 150, "variable": "LV", "value": 0.0}, {"deg": 155, "variable": "LV", "value": 0.0}, {"deg": 160, "variable": "LV", "value": 0.0}, {"deg": 165, "variable": "LV", "value": 0.0}, {"deg": 170, "variable": "LV", "value": 0.0}, {"deg": 175, "variable": "LV", "value": 0.0}, {"deg": -180, "variable": "MY", "value": 0.0}, {"deg": -175, "variable": "MY", "value": 0.0}, {"deg": -170, "variable": "MY", "value": 0.0}, {"deg": -165, "variable": "MY", "value": 0.0}, {"deg": -160, "variable": "MY", "value": 0.0}, {"deg": -155, "variable": "MY", "value": 0.0}, {"deg": -150, "variable": "MY", "value": 0.0}, {"deg": -145, "variable": "MY", "value": 0.0}, {"deg": -140, "variable": "MY", "value": 0.0}, {"deg": -135, "variable": "MY", "value": 0.0}, {"deg": -130, "variable": "MY", "value": 0.0}, {"deg": -125, "variable": "MY", "value": 0.0}, {"deg": -120, "variable": "MY", "value": 0.0}, {"deg": -115, "variable": "MY", "value": 0.0}, {"deg": -110, "variable": "MY", "value": 0.0}, {"deg": -105, "variable": "MY", "value": 0.0}, {"deg": -100, "variable": "MY", "value": 0.0}, {"deg": -95, "variable": "MY", "value": 0.0}, {"deg": -90, "variable": "MY", "value": 0.0}, {"deg": -85, "variable": "MY", "value": 0.0}, {"deg": -80, "variable": "MY", "value": 0.0}, {"deg": -75, "variable": "MY", "value": 0.0}, {"deg": -70, "variable": "MY", "value": 0.19727272727272727}, {"deg": -65, "variable": "MY", "value": 0.25011008366358434}, {"deg": -60, "variable": "MY", "value": 0.059356136820925554}, {"deg": -55, "variable": "MY", "value": 0.4572089437162683}, {"deg": -50, "variable": "MY", "value": 0.6862026862026862}, {"deg": -45, "variable": "MY", "value": 0.6770167427701674}, {"deg": -40, "variable": "MY", "value": 0.7232323232323232}, {"deg": -35, "variable": "MY", "value": 0.7191392978482446}, {"deg": -30, "variable": "MY", "value": 0.7151720248166948}, {"deg": -25, "variable": "MY", "value": 0.7163677130044843}, {"deg": -20, "variable": "MY", "value": 0.7244050913115662}, {"deg": -15, "variable": "MY", "value": 0.7340366463076069}, {"deg": -10, "variable": "MY", "value": 0.7578316535004086}, {"deg": -5, "variable": "MY", "value": 0.7644976858154098}, {"deg": 0, "variable": "MY", "value": 0.7656040717921243}, {"deg": 5, "variable": "MY", "value": 0.7713513513513514}, {"deg": 10, "variable": "MY", "value": 0.7914177077675176}, {"deg": 15, "variable": "MY", "value": 0.7769465225824328}, {"deg": 20, "variable": "MY", "value": 0.7893873085339168}, {"deg": 25, "variable": "MY", "value": 0.7689732142857143}, {"deg": 30, "variable": "MY", "value": 0.7809894385769872}, {"deg": 35, "variable": "MY", "value": 0.772027972027972}, {"deg": 40, "variable": "MY", "value": 0.743446737311768}, {"deg": 45, "variable": "MY", "value": 0.7049459920409323}, {"deg": 50, "variable": "MY", "value": 0.6786239341370185}, {"deg": 55, "variable": "MY", "value": 0.6700386789645939}, {"deg": 60, "variable": "MY", "value": 0.6039290240811154}, {"deg": 65, "variable": "MY", "value": 0.6275713847098557}, {"deg": 70, "variable": "MY", "value": 0.560392798690671}, {"deg": 75, "variable": "MY", "value": 0.40675174969123096}, {"deg": 80, "variable": "MY", "value": 0.48678823967249724}, {"deg": 85, "variable": "MY", "value": 0.13581684128831975}, {"deg": 90, "variable": "MY", "value": 0.029689608636977057}, {"deg": 95, "variable": "MY", "value": 0.004714757190004715}, {"deg": 100, "variable": "MY", "value": 0.0}, {"deg": 105, "variable": "MY", "value": 0.0}, {"deg": 110, "variable": "MY", "value": 0.0}, {"deg": 115, "variable": "MY", "value": 0.0}, {"deg": 120, "variable": "MY", "value": 0.0}, {"deg": 125, "variable": "MY", "value": 0.0}, {"deg": 130, "variable": "MY", "value": 0.0}, {"deg": 135, "variable": "MY", "value": 0.0}, {"deg": 140, "variable": "MY", "value": 0.0}, {"deg": 145, "variable": "MY", "value": 0.0}, {"deg": 150, "variable": "MY", "value": 0.0}, {"deg": 155, "variable": "MY", "value": 0.0}, {"deg": 160, "variable": "MY", "value": 0.0}, {"deg": 165, "variable": "MY", "value": 0.0}, {"deg": 170, "variable": "MY", "value": 0.0}, {"deg": 175, "variable": "MY", "value": 0.0}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<p>So there is quite a range (from -40 to 80 degrees) where prediction performance remains stable. This is sufficient not to worry about minor deviations.</p>
<p>Let’s have another look at the network moving to the wrong side of thorax when predicting on rotated images:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>gif_series(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    get_rotation_series(img(),trainedModel, start<span class="op">=</span><span class="dv">0</span>, end<span class="op">=</span><span class="dv">360</span>,step<span class="op">=</span><span class="dv">10</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"example/b0/rotation.gif"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span><span class="st">"deg"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    duration<span class="op">=</span><span class="dv">400</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="example/b0/rotation.gif" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">segmentation sensitivity to rotation</figcaption><p></p>
</figure>
</div>
</section>
<section id="sensitivity-to-cropping" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-to-cropping">Sensitivity to cropping</h3>
<p>Another variation that might occur in real life is a difference in field of view. This can happen due to different settings when acquiring the images or due to pre-processing steps in an analysis pipeline.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_crop_series(img(),trainedModel, start <span class="op">=</span> <span class="dv">5</span>, end <span class="op">=</span> <span class="dv">60</span>, step <span class="op">=</span> <span class="dv">10</span>), nrow<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-16-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>gif_series(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    get_crop_series(img(),trainedModel, start<span class="op">=</span><span class="dv">60</span>, end<span class="op">=</span><span class="dv">5</span>, step<span class="op">=-</span><span class="dv">5</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"example/b0/crop.gif"</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span><span class="st">"pixels"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    duration<span class="op">=</span><span class="dv">400</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="example/b0/crop.gif" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">segmentation sensitivity to rotation</figcaption><p></p>
</figure>
</div>
<p>This looks quite good. It seems to be okay to crop the image as long as the whole heart remains intact. As soon as we start to crop part of the heart the model is no longer able to find it (this is expected). It also does not start to predict heart somewhere, where it should not when cropping even further.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> eval_crop_series(img(),trueMask(),trainedModel,start <span class="op">=</span> <span class="dv">5</span>, components<span class="op">=</span>[<span class="st">"bg"</span>,<span class="st">"LV"</span>,<span class="st">"MY"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(alt</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a> .Chart(results.melt(id_vars<span class="op">=</span>[<span class="st">'pixels'</span>],value_vars<span class="op">=</span>[<span class="st">'LV'</span>,<span class="st">'MY'</span>]))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a> .mark_line()</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a> .encode(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>     x<span class="op">=</span><span class="st">"pixels"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>     y<span class="op">=</span><span class="st">"value"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>     color<span class="op">=</span><span class="st">"variable"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>     tooltip<span class="op">=</span><span class="st">"value"</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a> .properties(width<span class="op">=</span><span class="dv">700</span>,height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a> .interactive()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-b80fd1dc825a44c690f8429c3657d0f0"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-b80fd1dc825a44c690f8429c3657d0f0") {
      outputDiv = document.getElementById("altair-viz-b80fd1dc825a44c690f8429c3657d0f0");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-df9a1e91817539f91f5122ca9aa4ae56"}, "mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "tooltip": {"field": "value", "type": "quantitative"}, "x": {"field": "pixels", "type": "quantitative"}, "y": {"field": "value", "type": "quantitative"}}, "height": 300, "selection": {"selector002": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}, "width": 700, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json", "datasets": {"data-df9a1e91817539f91f5122ca9aa4ae56": [{"pixels": 5, "variable": "LV", "value": 0.7814241486068112}, {"pixels": 15, "variable": "LV", "value": 0.78287841191067}, {"pixels": 25, "variable": "LV", "value": 0.788923076923077}, {"pixels": 35, "variable": "LV", "value": 0.6143226919758412}, {"pixels": 45, "variable": "LV", "value": 0.0}, {"pixels": 55, "variable": "LV", "value": 1.0}, {"pixels": 5, "variable": "MY", "value": 0.7646112600536193}, {"pixels": 15, "variable": "MY", "value": 0.7582298974635726}, {"pixels": 25, "variable": "MY", "value": 0.7590491626148028}, {"pixels": 35, "variable": "MY", "value": 0.6443298969072165}, {"pixels": 45, "variable": "MY", "value": 0.0}, {"pixels": 55, "variable": "MY", "value": 1.0}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<p>The dice scores of 1 for very small sizes is because the model is not supposed to predict anything and it is not predicting anything. It drops to 0 when the heart starts to appear on the image but the model is still unable to locate it and then raises to the final performance it has on the whole image. Reaching a plateau at a size of 160px.</p>
</section>
<section id="sensitivity-to-brightness" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-to-brightness">Sensitivity to brightness</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_brightness_series(img(),trainedModel, start<span class="op">=</span>np.sqrt(<span class="dv">2</span>)<span class="op">/</span><span class="dv">8</span>), nrow<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> eval_bright_series(img(),trueMask(),trainedModel, components<span class="op">=</span>[<span class="st">"bg"</span>,<span class="st">"LV"</span>,<span class="st">"MY"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(alt</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a> .Chart(results.melt(id_vars<span class="op">=</span>[<span class="st">'brightness'</span>],value_vars<span class="op">=</span>[<span class="st">'LV'</span>,<span class="st">'MY'</span>]))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a> .mark_line()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a> .encode(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>     x<span class="op">=</span><span class="st">"brightness"</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>     y<span class="op">=</span><span class="st">"value"</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>     color<span class="op">=</span><span class="st">"variable"</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>     tooltip<span class="op">=</span><span class="st">"value"</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a> .properties(width<span class="op">=</span><span class="dv">700</span>,height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a> .interactive()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-1ec1307a51d84693bce05b5c3c18e87a"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-1ec1307a51d84693bce05b5c3c18e87a") {
      outputDiv = document.getElementById("altair-viz-1ec1307a51d84693bce05b5c3c18e87a");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-3d444b309369b9328a3bb90952fc64ab"}, "mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "tooltip": {"field": "value", "type": "quantitative"}, "x": {"field": "brightness", "type": "quantitative"}, "y": {"field": "value", "type": "quantitative"}}, "height": 300, "selection": {"selector003": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}, "width": 700, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json", "datasets": {"data-3d444b309369b9328a3bb90952fc64ab": [{"brightness": 0.05, "variable": "LV", "value": 0.0}, {"brightness": 0.1, "variable": "LV", "value": 0.8182419035029742}, {"brightness": 0.15000000000000002, "variable": "LV", "value": 0.8179551122194514}, {"brightness": 0.2, "variable": "LV", "value": 0.8051628764597418}, {"brightness": 0.25, "variable": "LV", "value": 0.8076213890596189}, {"brightness": 0.3, "variable": "LV", "value": 0.7894736842105263}, {"brightness": 0.35000000000000003, "variable": "LV", "value": 0.8056930693069307}, {"brightness": 0.4, "variable": "LV", "value": 0.7946210268948656}, {"brightness": 0.45, "variable": "LV", "value": 0.8}, {"brightness": 0.5, "variable": "LV", "value": 0.78735275883447}, {"brightness": 0.55, "variable": "LV", "value": 0.7891491985203453}, {"brightness": 0.6000000000000001, "variable": "LV", "value": 0.782716049382716}, {"brightness": 0.6500000000000001, "variable": "LV", "value": 0.7812692544670363}, {"brightness": 0.7000000000000001, "variable": "LV", "value": 0.7778461538461539}, {"brightness": 0.7500000000000001, "variable": "LV", "value": 0.79}, {"brightness": 0.8, "variable": "LV", "value": 0.7775030902348579}, {"brightness": 0.8500000000000001, "variable": "LV", "value": 0.7763401109057301}, {"brightness": 0.9000000000000001, "variable": "LV", "value": 0.7823383084577115}, {"brightness": 0.05, "variable": "MY", "value": 0.0}, {"brightness": 0.1, "variable": "MY", "value": 0.7151552038953134}, {"brightness": 0.15000000000000002, "variable": "MY", "value": 0.7710293698317651}, {"brightness": 0.2, "variable": "MY", "value": 0.7587548638132295}, {"brightness": 0.25, "variable": "MY", "value": 0.766457252116908}, {"brightness": 0.3, "variable": "MY", "value": 0.7595970596242854}, {"brightness": 0.35000000000000003, "variable": "MY", "value": 0.7814605227701428}, {"brightness": 0.4, "variable": "MY", "value": 0.7660488853075477}, {"brightness": 0.45, "variable": "MY", "value": 0.7789133942980097}, {"brightness": 0.5, "variable": "MY", "value": 0.7650214592274678}, {"brightness": 0.55, "variable": "MY", "value": 0.7631508678237651}, {"brightness": 0.6000000000000001, "variable": "MY", "value": 0.7632072941807455}, {"brightness": 0.6500000000000001, "variable": "MY", "value": 0.7607066381156317}, {"brightness": 0.7000000000000001, "variable": "MY", "value": 0.755591054313099}, {"brightness": 0.7500000000000001, "variable": "MY", "value": 0.7696404793608522}, {"brightness": 0.8, "variable": "MY", "value": 0.7592839967940155}, {"brightness": 0.8500000000000001, "variable": "MY", "value": 0.7541245343267695}, {"brightness": 0.9000000000000001, "variable": "MY", "value": 0.7656040717921243}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
</section>
<section id="sensitivity-to-contrast" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-to-contrast">Sensitivity to contrast</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_contrast_series(img(),trainedModel, start<span class="op">=</span><span class="dv">1</span><span class="op">/</span><span class="dv">8</span>, end<span class="op">=</span>np.sqrt(<span class="dv">2</span>)<span class="op">*</span><span class="dv">8</span>), nrow <span class="op">=</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-23-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> eval_contrast_series(img(),trueMask(),trainedModel, components<span class="op">=</span>[<span class="st">"bg"</span>,<span class="st">"LV"</span>,<span class="st">"MY"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(alt</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a> .Chart(results.melt(id_vars<span class="op">=</span>[<span class="st">'contrast'</span>],value_vars<span class="op">=</span>[<span class="st">'LV'</span>,<span class="st">'MY'</span>]))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a> .mark_line(point<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a> .encode(</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>     x<span class="op">=</span>alt.X(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>     <span class="st">"contrast"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>     scale<span class="op">=</span>alt.Scale(<span class="bu">type</span><span class="op">=</span><span class="st">"log"</span>)),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>     y<span class="op">=</span><span class="st">"value"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>     color<span class="op">=</span><span class="st">"variable"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>     tooltip<span class="op">=</span><span class="st">"value"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a> .properties(width<span class="op">=</span><span class="dv">700</span>,height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a> .interactive()</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-432abb92a0844f13856dba87085b1cfc"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-432abb92a0844f13856dba87085b1cfc") {
      outputDiv = document.getElementById("altair-viz-432abb92a0844f13856dba87085b1cfc");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-12ad7f5a712d28aa958bb340290f3e29"}, "mark": {"type": "line", "point": true}, "encoding": {"color": {"field": "variable", "type": "nominal"}, "tooltip": {"field": "value", "type": "quantitative"}, "x": {"field": "contrast", "scale": {"type": "log"}, "type": "quantitative"}, "y": {"field": "value", "type": "quantitative"}}, "height": 300, "selection": {"selector004": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}, "width": 700, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json", "datasets": {"data-12ad7f5a712d28aa958bb340290f3e29": [{"contrast": 0.25, "variable": "LV", "value": 0.8037151702786378}, {"contrast": 1.6642135623730951, "variable": "LV", "value": 0.7916921197312157}, {"contrast": 3.0784271247461903, "variable": "LV", "value": 0.7871962062833432}, {"contrast": 4.492640687119286, "variable": "LV", "value": 0.7777777777777778}, {"contrast": 5.906854249492381, "variable": "LV", "value": 0.7855450236966824}, {"contrast": 7.3210678118654755, "variable": "LV", "value": 0.7675233644859814}, {"contrast": 0.25, "variable": "MY", "value": 0.7873974053481599}, {"contrast": 1.6642135623730951, "variable": "MY", "value": 0.7568881685575365}, {"contrast": 3.0784271247461903, "variable": "MY", "value": 0.740782122905028}, {"contrast": 4.492640687119286, "variable": "MY", "value": 0.7439724454649828}, {"contrast": 5.906854249492381, "variable": "MY", "value": 0.752851711026616}, {"contrast": 7.3210678118654755, "variable": "MY", "value": 0.7279878971255673}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
</section>
<section id="sensitivity-to-zoom" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-to-zoom">Sensitivity to zoom</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_zoom_series(img(),trainedModel))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-26-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> eval_zoom_series(img(),trueMask(),trainedModel,components<span class="op">=</span>[<span class="st">"bg"</span>,<span class="st">"LV"</span>,<span class="st">"MY"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(alt</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a> .Chart(results.melt(id_vars<span class="op">=</span>[<span class="st">'scale'</span>],value_vars<span class="op">=</span>[<span class="st">'LV'</span>,<span class="st">'MY'</span>]))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a> .mark_line()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a> .encode(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>     x<span class="op">=</span><span class="st">"scale"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>     y<span class="op">=</span><span class="st">"value"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>     color<span class="op">=</span><span class="st">"variable"</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>     tooltip<span class="op">=</span><span class="st">"value"</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a> .properties(width<span class="op">=</span><span class="dv">700</span>,height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a> .interactive()</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-5d0c9bae8697426dbbab22066349845d"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-5d0c9bae8697426dbbab22066349845d") {
      outputDiv = document.getElementById("altair-viz-5d0c9bae8697426dbbab22066349845d");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-4e2a58405bc7b28a4989d0519d39fb8a"}, "mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "tooltip": {"field": "value", "type": "quantitative"}, "x": {"field": "scale", "type": "quantitative"}, "y": {"field": "value", "type": "quantitative"}}, "height": 300, "selection": {"selector005": {"type": "interval", "bind": "scales", "encodings": ["x", "y"]}}, "width": 700, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json", "datasets": {"data-4e2a58405bc7b28a4989d0519d39fb8a": [{"scale": 0.0, "variable": "LV", "value": 0.782608695652174}, {"scale": 0.1, "variable": "LV", "value": 0.7104666968735841}, {"scale": 0.2, "variable": "LV", "value": 0.7076064200976971}, {"scale": 0.30000000000000004, "variable": "LV", "value": 0.694815606627472}, {"scale": 0.4, "variable": "LV", "value": 0.6104333193100547}, {"scale": 0.5, "variable": "LV", "value": 0.3701393983859134}, {"scale": 0.6000000000000001, "variable": "LV", "value": 0.1252408477842004}, {"scale": 0.7000000000000001, "variable": "LV", "value": 0.0}, {"scale": 0.8, "variable": "LV", "value": 0.0}, {"scale": 0.9, "variable": "LV", "value": 1.0}, {"scale": 0.0, "variable": "MY", "value": 0.7656040717921243}, {"scale": 0.1, "variable": "MY", "value": 0.7460571428571429}, {"scale": 0.2, "variable": "MY", "value": 0.737782640408461}, {"scale": 0.30000000000000004, "variable": "MY", "value": 0.7038690476190477}, {"scale": 0.4, "variable": "MY", "value": 0.5534030079021157}, {"scale": 0.5, "variable": "MY", "value": 0.35380434782608694}, {"scale": 0.6000000000000001, "variable": "MY", "value": 0.1309448319594166}, {"scale": 0.7000000000000001, "variable": "MY", "value": 0.0}, {"scale": 0.8, "variable": "MY", "value": 0.0}, {"scale": 0.9, "variable": "MY", "value": 1.0}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>gif_series(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    get_zoom_series(img(),trainedModel),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"example/b0/zoom.gif"</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span><span class="st">"scale"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    duration<span class="op">=</span><span class="dv">400</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="example/b0/zoom.gif" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">segmentation sensitivity to zoom</figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="robustness-to-mr-artifacts" class="level2">
<h2 class="anchored" data-anchor-id="robustness-to-mr-artifacts">Robustness to MR artifacts</h2>
<section id="spike-artifact" class="level3">
<h3 class="anchored" data-anchor-id="spike-artifact">Spike artifact</h3>
<p>Spike artifacts can happen with different intensities and at different locations in k-space. It is even possible to have multiple spikes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> misas.mri <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First we consider a single spike quite far from the center of k-space.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_spike_series(img(),trainedModel))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-31-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Segmentation performance is heavily impacted by this kind of artifact. The training examples did not have a single example with this <em>herringbone</em> pattern so we even get striped predictions for the myocardium.</p>
<p>Let’s have a look how the location of the spike in k-space changes the artifact and model performance. From top to bottom, moving farter from the center.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> [<span class="fl">.51</span>,<span class="fl">.55</span>,<span class="fl">.6</span>,<span class="fl">.75</span>]:</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    plot_series(get_spike_series(img(),trainedModel,spikePosition<span class="op">=</span>[i,i]), param_name<span class="op">=</span><span class="st">"intensity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-32-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-32-output-6.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-32-output-7.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-32-output-8.png" class="img-fluid"></p>
</div>
</div>
<p>So spikes closer to the center of k-space create artifacts with lower frequency and have less severe impact on segmentation performance.</p>
<p>So far we only looked at spikes on the diagonal of k-space, for the sake of completeness we can also look at arbitrary locations in k-space.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">7</span>,<span class="dv">7</span>,figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">16</span>))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> [<span class="fl">.4</span>,<span class="fl">.45</span>,<span class="fl">.49</span>,<span class="fl">.5</span>,<span class="fl">.51</span>,<span class="fl">.55</span>,<span class="fl">.6</span>]</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>values<span class="op">=</span><span class="bu">list</span>(itertools.product(values, values))</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x, ax <span class="kw">in</span> <span class="bu">zip</span>(values, axs.flatten()):</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    im <span class="op">=</span> trainedModel.prepareSize(img())</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    im <span class="op">=</span> spikeTransform(im,<span class="fl">.5</span>,<span class="bu">list</span>(x))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    ax.imshow(np.array(im))</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    ax.imshow(np.array(trainedModel.predict(im)), cmap<span class="op">=</span>default_cmap, alpha<span class="op">=</span><span class="fl">.5</span>, interpolation<span class="op">=</span><span class="st">"nearest"</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    ax.axes.xaxis.set_visible(<span class="va">False</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    ax.axes.yaxis.set_visible(<span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="b_0-field-inhomogeneity" class="level3">
<h3 class="anchored" data-anchor-id="b_0-field-inhomogeneity"><span class="math inline">\(B_0\)</span>-Field inhomogeneity</h3>
<p><span class="math inline">\(B_0\)</span>-Field inhomogeneieties are quite common, particularly at higher field strength. Adjusting these inhomogeneities at ultra high field strength (shimming) is an active field of research (Hock et al.&nbsp;2020). So what is the impact of this so-called Bias field:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>plot_series(get_biasfield_series(img(),trainedModel))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_transversals_files/figure-html/cell-34-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The model works (at least on this example) reliably for even very intense field inhomogeneities.</p>


</section>
</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>